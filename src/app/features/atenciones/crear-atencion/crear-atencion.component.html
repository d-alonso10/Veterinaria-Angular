<div class="main-content">
  <!-- ğŸ†• LOADING OVERLAY PARA POLLING -->
  @if (showLoadingOverlay()) {
    <div class="loading-overlay">
      <div class="loading-overlay-content">
        <div class="spinner-large"></div>
        <h3>{{ loadingMessage() }}</h3>
        <p>Por favor espera...</p>
      </div>
    </div>
  }

  <div class="header-section">
    <div class="header-left">
      <h2>âœ¨ Nueva AtenciÃ³n</h2>
      <p class="subtitle">Crear atenciÃ³n desde una cita programada</p>
    </div>
    <button class="btn-secondary" (click)="volver()">
      â† Volver
    </button>
  </div>

  <div class="card">
    @if (isLoading()) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Cargando datos...</p>
      </div>
    } @else {
      <form [formGroup]="atencionForm" (ngSubmit)="onSubmit()">

        <!-- SelecciÃ³n de Cita -->
        <div class="form-section">
          <h3>ğŸ“‹ Seleccionar Cita</h3>
          <div class="form-group">
            <label for="idCita">
              <span class="label-icon">ğŸ“…</span>
              Cita Pendiente *
            </label>
            <select
              id="idCita"
              formControlName="idCita"
              (change)="onCitaChange($event)"
              class="form-select"
            >
              <option value="">Seleccione una cita...</option>
              @for (cita of citasDisponibles(); track cita.idCita) {
                <option [value]="cita.idCita">
                  #{{cita.idCita}} - {{cita.nombreMascota}} ({{cita.nombreCliente}}) - {{cita.fechaProgramada | date:'dd/MM/yyyy HH:mm'}}
                </option>
              }
            </select>
          </div>

          <!-- Info de la Cita Seleccionada -->
          @if (citaSeleccionada()) {
            <div class="cita-info">
              <h4>ğŸ“‹ InformaciÃ³n de la Cita</h4>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">ğŸ¾ Mascota:</span>
                  <span class="info-value">{{citaSeleccionada().nombreMascota}}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">ğŸ‘¤ Cliente:</span>
                  <span class="info-value">{{citaSeleccionada().nombreCliente}}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">ğŸ“ Motivo:</span>
                  <span class="info-value">{{citaSeleccionada().motivo || 'No especificado'}}</span>
                </div>
              </div>
            </div>
          }
        </div>

        <div class="divider"></div>

        <!-- Detalles de la AtenciÃ³n -->
        <div class="form-section">
          <h3>ğŸ¯ Detalles de la AtenciÃ³n</h3>

          <div class="form-row">
            <div class="form-group">
              <label for="idGroomer">
                <span class="label-icon">ğŸ‘¨â€ğŸ’¼</span>
                Groomer Asignado *
              </label>
              <select
                id="idGroomer"
                formControlName="idGroomer"
                class="form-select"
              >
                <option value="">Seleccione un groomer...</option>
                @for (groomer of groomersDisponibles(); track groomer.idGroomer) {
                  <option [value]="groomer.idGroomer">
                    {{groomer.nombre}}
                  </option>
                }
              </select>
            </div>

            <div class="form-group">
              <label for="turnoNum">
                <span class="label-icon">#ï¸âƒ£</span>
                Turno
              </label>
              <div class="input-with-button">
                <input
                  type="number"
                  id="turnoNum"
                  formControlName="turnoNum"
                  class="form-input"
                  min="1"
                />
                <button type="button" class="btn-icon" (click)="autoGenerarTurno()" title="Generar nuevo turno">
                  ğŸ”„
                </button>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="prioridad">
              <span class="label-icon">ğŸ¯</span>
              Prioridad *
            </label>
            <select
              id="prioridad"
              formControlName="prioridad"
              class="form-select"
            >
              <option value="1">â­â­â­â­â­ Urgente (1)</option>
              <option value="2">â­â­â­â­ Alta (2)</option>
              <option value="3">â­â­â­ Normal (3)</option>
              <option value="4">â­â­ Baja (4)</option>
              <option value="5">â­ Muy Baja (5)</option>
            </select>
          </div>
        </div>

        <!-- Botones de AcciÃ³n -->
        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="volver()">
            âœ• Cancelar
          </button>
          <button
            type="submit"
            class="btn-primary"
            [disabled]="!atencionForm.valid || isProcessing()"
          >
            @if (isProcessing()) {
              <span class="spinner-small"></span>
              Procesando...
            } @else {
              âœ… Crear AtenciÃ³n
            }
          </button>
        </div>
      </form>
    }
  </div>
</div>
